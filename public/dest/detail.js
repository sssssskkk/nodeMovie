$(function(){function main(){(function(){var com_login=$("#com_login");$("#change"),$("#login_username").text().trim();com_login.click(function(){var mas='<div id="mask"><div id="update-info" class="update-info"><div class="message"><div class="c-login"><div id="m-close">x</div><div class="update-title"><h1>用户登录</h1></div><div class="form clearfix"><form action="#" method="post"><div class="write"><div class="input inputuser"><em class="usericon"><i class="iconfont">&#xe617;</i></em> <label for="com_sign_user"><input type="text" id="com_sign_user" name="user_name" maxlength="25" autocomplete="off" placeholder="用户名"></label> <span class="usertxt clearfix"></span></div><div class="input inputpawd"><em class="paswicon"><i class="iconfont">&#xe692;</i></em> <label for="com_sign_pswd"><input type="password" id="com_sign_pswd" name="user_paswd" maxlength="25" autocomplete="off" placeholder="密码"></label>   <span class="paswtxt"></span></div></div><div class="sign"><div class="keepalive"><label><input type="checkbox" id="com_checkbox"> 记住密码</label></div><div class="comfirm"><input type="button" id="update-confirm" value="登录"></div></div></form></div></div></div></div></div>';$(mas).insertAfter("#contai-info"),$("#mask").fadeIn(180),$("#contai-info").css({"-webkit-filter":"blur(3px)","-moz-filter":"blur(3px)","-ms-filter":"blur(3px)","-o-filter":" blur(3px)",filter:"blur(3px)",filter:" progid:DXImageTransform.Microsoft.Blur(PixelRadius=4, MakeShadow=false)"})}),$("body").delegate("#m-close","click",function(){$(this).parent().remove(),$("#mask").remove(),$("#contai-info").css({"-webkit-filter":"none","-moz-filter":"none","-ms-filter":"none","-o-filter":" none",filter:"none"})}),$("body").delegate("#cancle","click",function(){$("#update-info").remove(),$("#mask").remove(),$("#contai-info").css({"-webkit-filter":"none","-moz-filter":"none","-ms-filter":"none","-o-filter":" none",filter:"none"})})})(),function(){$("#com_login").click(function(){return"true"!=$.cookie("userCookie")?!1:($("#com_checkbox").attr("checked",!0),$("#com_sign_user").val($.cookie("username")),$("#com_sign_pswd").val($.cookie("password")),void 0)})}(),function(){$("#update-confirm").click(function(){if($("#com_checkbox").is(":checked")){var user=($("#com_checkbox"),$("#com_sign_user").val()),pswd=$("#com_sign_pswd").val();$.cookie("userCookie","true",{expires:7}),$.cookie("username",user,{expires:7}),$.cookie("password",pswd,{expires:7})}else $.cookie("userCookie","false",{expires:-1}),$.cookie("username","",{expires:-1}),$.cookie("password","",{expires:-1})})}(),function(){$("body").delegate("#update-confirm","click",function(){var username=$("#com_sign_user").val(),password=$("#com_sign_pswd").val(),movieId=$("#mov").data("movid");$.ajax({url:"/comsignin",type:"post",data:{username:username,password:password,movieId:movieId},cache:!1,success:function(data){0==data.msg?(alert("不存在用户"),window.location.href="/register"):2==data.msg?$("#mask .form .paswtxt").text("密码错误"):1==data.msg&&(window.location.href="/movie/"+data.movie)}})})}(),function(){$("#commentForm textarea").focus(function(){$(this).css("border","1px solid #3198F0")}).blur(function(){$(this).css("border","1px solid #cccccc")});var dls=$("#comment #cont-list>dl");dls.length>=10?$("#click_more").show():$("#click_more").hide(),$("body").delegate("#not_login_close","click",function(event){$(this).parent().remove()})}(),function(){$(".load .showuser").mouseover(function(){$(this).find("ul").stop().slideDown("fast")}),$(".load .showuser").mouseout(function(){$(this).find("ul").stop().slideUp("fast")})}(),function(){var username=$(".has-signin .con-name span");$(".has-signin .con-name").width()-username.width()<=8&&username.height()>50&&$(".has-signin .com-user .con-name").css("line-height","25px")}(),function(){if(!$("#login_username").text())return!1;var userId=$("#login_username").data("colid"),colpeople=$("#mov").data("colpeople"),colarr=colpeople.split(","),dls=$("#cont-list dl");colarr.indexOf(userId)>-1?($(".collect").find("a").text("已收藏"),$(".collect").find("span").css("background","url(/images/s_ok.png) no-repeat top center"),$(".collect").css("background","transparent")):($(".collect").find("a").text("收藏"),$(".collect").find("span").css("background","url(/images/s_no.png) no-repeat top center")),$("#mov").removeAttr("data-colpeople"),dls.each(function(index,item){var $item=$(this),prises=$item.data("pripeo");if(prises)if(prises.indexOf(",")>-1){var prisesarr=prises.split(",");prisesarr.indexOf(userId)>-1?$item.find("dd .reply-btn .com-prise").css({background:"url('/images/heart.png') no-repeat 3px 2px","background-size":"24px 24px"}):$item.find("dd .reply-btn .com-prise").css("background","url('/images/ico.png') no-repeat 0 -860px")}else prises==userId?$item.find("dd .reply-btn .com-prise").css({background:"url('/images/heart.png') no-repeat 3px 2px","background-size":"24px 24px"}):$item.find("dd .reply-btn .com-prise").css("background","url('/images/ico.png') no-repeat 0 -860px")})}(),function(){var userId=$("#login_username").data("colid"),movieId=$("#mov").data("movid");$(".collect").click(function(){$.ajax({type:"POST",url:"/user/shoucang",data:{colUserId:userId,colMovieId:movieId},cache:!1,dataType:"json",success:function(data){1==parseInt(data.col)?($(".collect").find("a").text("已收藏"),$(".collect").find("span").css("background","url(/images/s_ok.png) no-repeat top center"),$(".collect").css("background","transparent")):($(".collect").find("a").text("收藏"),$(".collect").find("span").css("background","url(/images/s_no.png) no-repeat top center"))}})})}(),function(){var clipboard=new Clipboard("#copy_btn");clipboard.on("success",function(e){}),clipboard.on("error",function(e){})}();$(".updateNow").each(function(index,item){var commentTime=$(this).attr("time"),resetTime=(new Date).ago(commentTime);$(this).html(resetTime)}),$(".replyTime").each(function(index,item){var commentTime=$(this).attr("time"),resetTime=(new Date).ago(commentTime);$(this).html(resetTime)});(function(){function send(el){return{have:function(){var form=el.parentNode.parentNode,textarea=form.children[2],all=el.parentNode.parentNode.parentNode.parentNode.parentNode,currentName=$("#login_username").attr("title"),movieId=form.children[0].value,fromId=form.children[1].value,content=form.children[2].value,toId=form.children[4].value,commentId=form.children[5].value,userId=$("#login_username").data("colid");$.ajax({type:"POST",url:"/user/comment",data:{movieId:movieId,fromId:fromId,content:content,toId:toId,commentId:commentId,userId:userId},cache:!1,dataType:"json",success:function(data){var createTime=(new Date).getTime(),showTime=(new Date).ago(createTime),comment=data.comment,replyInfo=comment.reply,lastReplyInfo=replyInfo[replyInfo.length-1],pic="";pic=""!=data.user.pic?"/upload/"+data.user.pic:"/images/moren.png";var html='<div class="new-box-left"><a href="javascript:;" data-cid="'+comment._id+'" data-tid="'+lastReplyInfo.from+'"><img src="'+pic+'" alt="用户头像"></a></div><div class="new-box-right"><div class="one-rpl-cont"><a href="javascript:;">'+currentName+"</a>: "+lastReplyInfo.content+'</div><div class="loadup"><span class="left">'+showTime+'</span><span class="clearfix"><button class="two-rpl-btn" title="回复" data-cid="'+comment._id+'" data-tid="'+lastReplyInfo.from+'"></button></span></div></div>',newbox=document.createElement("div");newbox.className="new-reply-box",newbox.innerHTML=html,all.appendChild(newbox),textarea.value=""}})},not:function(){var mask_login='<div id="mask-login"><h3>请先登录再进行评论！</h3><p id="not_login_close">知道了</p></div>';$("#contai-info").append(mask_login)}}}function replyComment(el){var target=el.parentNode.parentNode.parentNode.previousElementSibling.children[0],replyForm=el.parentNode.nextElementSibling.children[0].children[1].children[0],toId=target.getAttribute("data-tid"),commentId=target.getAttribute("data-cid");if(replyForm.getElementsByClassName("toID").length>0)return void(replyForm.getElementsByClassName("toID").value=toId);var inputnode1=document.createElement("input");if(inputnode1.type="hidden",inputnode1.name="comment[tid]",inputnode1.className="toID",inputnode1.value=toId,replyForm.appendChild(inputnode1),replyForm.getElementsByClassName("commentID").length>0)return void(replyForm.getElementsByClassName("commentID").value=toId);var inputnode2=document.createElement("input");inputnode2.type="hidden",inputnode2.name="comment[cid]",inputnode2.className="commentID",inputnode2.value=commentId,replyForm.appendChild(inputnode2)}function replyUser(el){var formNode=el.parentNode.parentNode.parentNode.parentNode.parentNode.children[0].children[1].children[0],toId=el.getAttribute("data-tid"),commentId=el.getAttribute("data-cid");if(formNode.getElementsByClassName("toID").length>0)return void(formNode.getElementsByClassName("toID").value=toId);var inputnode1=document.createElement("input");if(inputnode1.type="hidden",inputnode1.name="comment[tid]",inputnode1.className="toID",inputnode1.value=toId,formNode.appendChild(inputnode1),formNode.getElementsByClassName("commentID").length>0)return void(formNode.getElementsByClassName("commentID").value=commentId);var inputnode2=document.createElement("input");inputnode2.type="hidden",inputnode2.name="comment[cid]",inputnode2.className="commentID",inputnode2.value=commentId,formNode.appendChild(inputnode2)}function funcReplyEach(el){var formNode=el.parentNode.parentNode.parentNode.parentNode.parentNode.children[0].children[1].children[0].children[2],needReplyUserName=el.parentNode.parentNode.parentNode.children[0].children[0].innerHTML;formNode.value="回复@"+needReplyUserName+"："}function toggleComment(el){var o=el.parentNode.nextElementSibling,show=parseInt(o.getAttribute("show"));1!==show?(o.style.display="block",o.setAttribute("show",1)):1===show&&(o.style.display="none",o.setAttribute("show",0))}$("#comment").delegate("#commentForm .con-btn button","click",function(){if(""==$("#commentForm textarea").val())return alert("评论内容不能为空！"),!1;var parmas=$("#commentForm").serialize();$.ajax({type:"POST",url:"/user/comment",data:parmas,cache:!1,dataType:"json",success:function(data){var createTime=(new Date).getTime(),showTime=(new Date).ago(createTime),$comment=data.comment,pic="";pic=""!=data.pic?"/upload/"+data.pic:"/images/moren.png";var html='<dl class="clearfix" data-pripeo="'+$comment.pripeople+'"><dt><a href="javascript:;" data-cid="'+$comment._id+'" data-tid="'+$comment.from+'"><img src="'+pic+'" alt="userImg"></a></dt><dd><div class="all-info"><div class="content-info"><div class="content-title"><a href="javascript:;">'+$comment.username+'</a><span class="updateNow" time="'+createTime+'">'+showTime+'</span></div><div class="content-txt"><div class="con-txt"><p>'+$comment.content+'</p></div></div></div><div class="fun reply-btn"><a href="javascript:;" class="com-reply"></a><a href="javascript:;" class="com-prise" data-priid="'+$comment._id+'" onclick="prise(this)"></a></div><div class="reply-node" show=0><dl class="first-node"><dt><img src="'+pic+'"></a></dt><dd><form class="replyForm clearfix" method="POST" action="/user/comment"><input type="hidden" name="comment[movie]" value="'+$comment.movie+'"/><input type="hidden" name="comment[from]" value="'+$comment.from+'"/><textarea name="comment[content]" class="comonput"></textarea><div id="con-btn" class="con-btn clearfix"><button class="rpl-reply" type="button">发送</button></div><form/></dd></dl></div></div></dd></dl>';if(1==$("#cont-list .not-comment").length)if(0==$("#cont-list dl").length)$(html).insertBefore("#not_comment");else{var first_dl=$("#cont-list dl").eq(0);$(html).insertBefore(first_dl)}else{var first_dl=$("#cont-list dl").eq(0);$(html).insertBefore(first_dl)}},error:function(){console.log("发生异常错误")}}),$("#commentForm textarea").val("")}),$("#contents").delegate("#cont-list","click",function(event){var userId=$("#login_username").data("colid"),el=event.target;switch(el.className){case"rpl-reply":var use=send(el);userId?use.have():use.not();break;case"com-reply":replyComment(el),toggleComment(el);break;case"two-rpl-btn":replyUser(el),funcReplyEach(el);break;default:return!1}})})(),function(){var movieId=$("#mov").data("movid"),num=1,select_status="",userId=$("#login_username").data("colid");$("#cont-choice a").each(function(index,item){var $item=$(this);$item.click(function(){var select=$item.data("select");$("#click_more").attr("data-select",select),$item.addClass("select").siblings().removeClass("select"),num=1})}),$("#click_more").click(function(){var select=$("#cont-choice .select").text();"全部"==select?select_status="all":"最新"==select&&(select_status="new"),$.ajax({type:"POST",url:"/movie/contentMore",data:{movieId:movieId,num:num,status:select_status,userId:userId},cache:!1,dataType:"json",beforeSend:function(){$("#click_more").text("加载中...")},success:function(data){var comments=data.comments,datauser=data.user;if(datauser){$("#click_more").attr("data-have",data.have);var upic="";upic=""!=data.user.pic?"/upload/"+data.user.pic:"/images/moren.png";for(var i=0;i<comments.length;i++){var createTime=comments[i].meta.createAt,showTime=(new Date).ago(createTime),cpic="";cpic=""!=comments[i].from.pic?"/upload/"+comments[i].from.pic:"/images/moren.png";var reply=comments[i].reply;if(0==reply.length){var comment='<dl class="clearfix" data-pripeo="'+comments[i].pripeople+'"><dt><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+comments[i].from._id+'"><img src="'+cpic+'" alt="userImg"></a></dt><dd><div class="all-info"><div class="content-info"><div class="content-title"><a href="javascript:;">'+comments[i].username+'</a><span class="updateNow" time="'+createTime+'">'+showTime+'</span></div><div class="content-txt"><div class="con-txt"><p>'+comments[i].content+'</p></div></div></div><div class="fun reply-btn"><a href="javascript:;" class="com-reply"></a><a href="javascript:;" class="com-prise" data-priid="'+comments[i]._id+'" onclick="prise(this)"></a></div><div class="reply-node" show=0><dl class="first-node"><dt><img src="'+upic+'"></a></dt><dd><form class="replyForm clearfix" method="POST" action="/user/comment"><input type="hidden" name="comment[movie]" value="'+comments[i].movie+'"/><input type="hidden" name="comment[from]" value="'+data.user._id+'"/><textarea name="comment[content]" class="comonput"></textarea><div id="con-btn" class="con-btn clearfix"><button class="rpl-reply" type="button">发送</button></div><form/></dd></dl></div></div></dd></dl>';$("#cont-list").append(comment)}else{for(var rpic="",reply_str="",j=0;j<reply.length;j++){var replycreateTime=reply[j].meta.createAt,replyshowTime=(new Date).ago(replycreateTime);rpic=""!=reply[j].from.pic?"/upload/"+reply[j].from.pic:"/images/moren.png";var reply_con='<div class="new-reply-box"><div class="new-box-left"><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+reply[j].from._id+'"><img src="'+rpic+'" alt="用户头像"></a></div><div class="new-box-right"><div class="one-rpl-cont"><a href="javascript:;">'+reply[j].from.name+"</a>："+reply[j].content+'</div><div class="loadup"><span time="'+replycreateTime+'" class="clearfix replyTime">'+replyshowTime+'</span><span class="clearfix"><button title="回复" data-cid="'+comments[i]._id+'" data-tid="'+reply[j].from._id+'" class="two-rpl-btn"></button></span></div></div></div>';reply_str+=reply_con}var _comment='<dl class="clearfix" data-pripeo="'+comments[i].pripeople+'"><dt><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+comments[i].from._id+'"><img src="'+cpic+'" alt="userImg"></a></dt><dd><div class="all-info"><div class="content-info"><div class="content-title"><a href="javascript:;">'+comments[i].username+'</a><span class="updateNow" time="'+createTime+'">'+showTime+'</span></div><div class="content-txt"><div class="con-txt"><p>'+comments[i].content+'</p></div></div></div><div class="fun reply-btn"><a href="javascript:;" class="com-reply"></a><a href="javascript:;" class="com-prise" data-priid="'+comments[i]._id+'" onclick="prise(this)"></a></div><div class="reply-node" show=0><dl class="first-node"><dt><img src="'+upic+'"></a></dt><dd><form class="replyForm clearfix" method="POST" action="/user/comment"><input type="hidden" name="comment[movie]" value="'+comments[i].movie+'"/><input type="hidden" name="comment[from]" value="'+data.user._id+'"/><textarea name="comment[content]" class="comonput"></textarea><div id="con-btn" class="con-btn clearfix"><button class="rpl-reply" type="button">发送</button></div><form/></dd></dl>'+reply_str+"</div></div></dd></dl>";$("#cont-list").append(_comment)}}}else{$("#click_more").attr("data-have",data.have);for(var i=0;i<comments.length;i++){var createTime=comments[i].meta.createAt,showTime=(new Date).ago(createTime),cpic="";cpic=""!=comments[i].from.pic?"/upload/"+comments[i].from.pic:"/images/moren.png";var reply=comments[i].reply;if(0==reply.length){var comment='<dl class="clearfix" data-pripeo="'+comments[i].pripeople+'"><dt><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+comments[i].from._id+'"><img src="'+cpic+'" alt="userImg"></a></dt><dd><div class="all-info"><div class="content-info"><div class="content-title"><a href="javascript:;">'+comments[i].username+'</a><span class="updateNow" time="'+createTime+'">'+showTime+'</span></div><div class="content-txt"><div class="con-txt"><p>'+comments[i].content+'</p></div></div></div><div class="fun reply-btn"><a href="javascript:;" class="com-reply"></a><a href="javascript:;" class="com-prise" data-priid="'+comments[i]._id+'" onclick="prise(this)"></a></div><div class="reply-node" show=0><dl class="first-node"><dt><img src="/images/moren.png"></a></dt><dd><form class="replyForm clearfix" method="POST" action="/user/comment"><input type="hidden" name="comment[movie]" value="'+comments[i].movie+'"/><textarea name="comment[content]" class="comonput"></textarea><div id="con-btn" class="con-btn clearfix"><button class="rpl-reply" type="button">发送</button></div><form/></dd></dl></div></div></dd></dl>';$("#cont-list").append(comment)}else{for(var rpic="",reply_str="",j=0;j<reply.length;j++){var replycreateTime=reply[j].meta.createAt,replyshowTime=(new Date).ago(replycreateTime);rpic=""!=reply[j].from.pic?"/upload/"+reply[j].from.pic:"/images/moren.png";var reply_con='<div class="new-reply-box"><div class="new-box-left"><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+reply[j].from._id+'"><img src="'+rpic+'" alt="用户头像"></a></div><div class="new-box-right"><div class="one-rpl-cont"><a href="javascript:;">'+reply[j].from.name+"</a>："+reply[j].content+'</div><div class="loadup"><span time="'+replycreateTime+'" class="clearfix replyTime">'+replyshowTime+'</span><span class="clearfix"><button title="回复" data-cid="'+comments[i]._id+'" data-tid="'+reply[j].from._id+'" class="two-rpl-btn"></button></span></div></div></div>';reply_str+=reply_con}var _comment='<dl class="clearfix" data-pripeo="'+comments[i].pripeople+'"><dt><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+comments[i].from._id+'"><img src="'+cpic+'" alt="userImg"></a></dt><dd><div class="all-info"><div class="content-info"><div class="content-title"><a href="javascript:;">'+comments[i].username+'</a><span class="updateNow" time="'+createTime+'">'+showTime+'</span></div><div class="content-txt"><div class="con-txt"><p>'+comments[i].content+'</p></div></div></div><div class="fun reply-btn"><a href="javascript:;" class="com-reply"></a><a href="javascript:;" class="com-prise" data-priid="'+comments[i]._id+'" onclick="prise(this)"></a></div><div class="reply-node" show=0><dl class="first-node"><dt><img src="/images/moren.png"></a></dt><dd><form class="replyForm clearfix" method="POST" action="/user/comment"><input type="hidden" name="comment[movie]" value="'+comments[i].movie+'"/><textarea name="comment[content]" class="comonput"></textarea><div id="con-btn" class="con-btn clearfix"><button class="rpl-reply" type="button">发送</button></div><form/></dd></dl>'+reply_str+"</div></div></dd></dl>";$("#cont-list").append(_comment)}}}},complete:function(){var have_status=$("#click_more").data("have");if("have"==have_status?$("#click_more").text("点击加载更多"):"done"==have_status&&$("#click_more").text("已全部加载"),!$("#login_username").text())return!1;var userId=$("#login_username").data("colid"),dls=$("#cont-list dl");dls.each(function(index,item){var $item=$(this),prises=$item.data("pripeo");if(prises)if(prises.indexOf(",")>-1){var prisesarr=prises.split(",");prisesarr.indexOf(userId)>-1?$item.find("dd .reply-btn .com-prise").css({background:"url('/images/heart.png') no-repeat 3px 2px","background-size":"24px 24px"}):$item.find("dd .reply-btn .com-prise").css("background","url('/images/ico.png') no-repeat 0 -860px")}else prises==userId?$item.find("dd .reply-btn .com-prise").css({background:"url('/images/heart.png') no-repeat 3px 2px","background-size":"24px 24px"}):$item.find("dd .reply-btn .com-prise").css("background","url('/images/ico.png') no-repeat 0 -860px");$item.attr("data-pripeo","")})}}),num++})}(),function(){$("#select_new").click(function(){var movieId=$("#mov").data("movid"),userId=$("#login_username").data("colid");$.ajax({type:"POST",url:"/movie/contentNew",data:{movieId:movieId,userId:userId},cache:!1,dataType:"json",beforeSend:function(){$("#cont-list").html(""),$("#click_more").text("加载中...")},success:function(data){var comments=data.comments,datauser=data.user;if(datauser){$("#click_more").attr("data-have",data.have);var upic="";upic=""!=data.user.pic?"/upload/"+data.user.pic:"/images/moren.png";for(var i=0;i<comments.length;i++){var createTime=comments[i].meta.createAt,showTime=(new Date).ago(createTime),cpic="";cpic=""!=comments[i].from.pic?"/upload/"+comments[i].from.pic:"/images/moren.png";var reply=comments[i].reply;if(0==reply.length){var comment='<dl class="clearfix" data-pripeo="'+comments[i].pripeople+'"><dt><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+comments[i].from._id+'"><img src="'+cpic+'" alt="userImg"></a></dt><dd><div class="all-info"><div class="content-info"><div class="content-title"><a href="javascript:;">'+comments[i].username+'</a><span class="updateNow" time="'+createTime+'">'+showTime+'</span></div><div class="content-txt"><div class="con-txt"><p>'+comments[i].content+'</p></div></div></div><div class="fun reply-btn"><a href="javascript:;" class="com-reply"></a><a href="javascript:;" class="com-prise" data-priid="'+comments[i]._id+'" onclick="prise(this)"></a></div><div class="reply-node" show=0><dl class="first-node"><dt><img src="'+upic+'"></a></dt><dd><form class="replyForm clearfix" method="POST" action="/user/comment"><input type="hidden" name="comment[movie]" value="'+comments[i].movie+'"/><input type="hidden" name="comment[from]" value="'+data.user._id+'"/><textarea name="comment[content]" class="comonput"></textarea><div id="con-btn" class="con-btn clearfix"><button class="rpl-reply" type="button">发送</button></div><form/></dd></dl></div></div></dd></dl>';$("#cont-list").append(comment)}else{for(var rpic="",reply_str="",j=0;j<reply.length;j++){var replycreateTime=reply[j].meta.createAt,replyshowTime=(new Date).ago(replycreateTime);rpic=""!=reply[j].from.pic?"/upload/"+reply[j].from.pic:"/images/moren.png";var reply_con='<div class="new-reply-box"><div class="new-box-left"><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+reply[j].from._id+'"><img src="'+rpic+'" alt="用户头像"></a></div><div class="new-box-right"><div class="one-rpl-cont"><a href="javascript:;">'+reply[j].from.name+"</a>："+reply[j].content+'</div><div class="loadup"><span time="'+replycreateTime+'" class="clearfix replyTime">'+replyshowTime+'</span><span class="clearfix"><button title="回复" data-cid="'+comments[i]._id+'" data-tid="'+reply[j].from._id+'" class="two-rpl-btn"></button></span></div></div></div>';reply_str+=reply_con}var _comment='<dl class="clearfix" data-pripeo="'+comments[i].pripeople+'"><dt><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+comments[i].from._id+'"><img src="'+cpic+'" alt="userImg"></a></dt><dd><div class="all-info"><div class="content-info"><div class="content-title"><a href="javascript:;">'+comments[i].username+'</a><span class="updateNow" time="'+createTime+'">'+showTime+'</span></div><div class="content-txt"><div class="con-txt"><p>'+comments[i].content+'</p></div></div></div><div class="fun reply-btn"><a href="javascript:;" class="com-reply"></a><a href="javascript:;" class="com-prise" data-priid="'+comments[i]._id+'" onclick="prise(this)"></a></div><div class="reply-node" show=0><dl class="first-node"><dt><img src="'+upic+'"></a></dt><dd><form class="replyForm clearfix" method="POST" action="/user/comment"><input type="hidden" name="comment[movie]" value="'+comments[i].movie+'"/><input type="hidden" name="comment[from]" value="'+data.user._id+'"/><textarea name="comment[content]" class="comonput"></textarea><div id="con-btn" class="con-btn clearfix"><button class="rpl-reply" type="button">发送</button></div><form/></dd></dl>'+reply_str+"</div></div></dd></dl>";$("#cont-list").append(_comment)}}}else{$("#click_more").attr("data-have",data.have);for(var i=0;i<comments.length;i++){var createTime=comments[i].meta.createAt,showTime=(new Date).ago(createTime),cpic="";cpic=""!=comments[i].from.pic?"/upload/"+comments[i].from.pic:"/images/moren.png";var reply=comments[i].reply;if(0==reply.length){var comment='<dl class="clearfix" data-pripeo="'+comments[i].pripeople+'"><dt><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+comments[i].from._id+'"><img src="'+cpic+'" alt="userImg"></a></dt><dd><div class="all-info"><div class="content-info"><div class="content-title"><a href="javascript:;">'+comments[i].username+'</a><span class="updateNow" time="'+createTime+'">'+showTime+'</span></div><div class="content-txt"><div class="con-txt"><p>'+comments[i].content+'</p></div></div></div><div class="fun reply-btn"><a href="javascript:;" class="com-reply"></a><a href="javascript:;" class="com-prise" data-priid="'+comments[i]._id+'" onclick="prise(this)"></a></div><div class="reply-node" show=0><dl class="first-node"><dt><img src="/images/moren.png"></a></dt><dd><form class="replyForm clearfix" method="POST" action="/user/comment"><input type="hidden" name="comment[movie]" value="'+comments[i].movie+'"/><textarea name="comment[content]" class="comonput"></textarea><div id="con-btn" class="con-btn clearfix"><button class="rpl-reply" type="button">发送</button></div><form/></dd></dl></div></div></dd></dl>';$("#cont-list").append(comment)}else{for(var rpic="",reply_str="",j=0;j<reply.length;j++){var replycreateTime=reply[j].meta.createAt,replyshowTime=(new Date).ago(replycreateTime);rpic=""!=reply[j].from.pic?"/upload/"+reply[j].from.pic:"/images/moren.png";var reply_con='<div class="new-reply-box"><div class="new-box-left"><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+reply[j].from._id+'"><img src="'+rpic+'" alt="用户头像"></a></div><div class="new-box-right"><div class="one-rpl-cont"><a href="javascript:;">'+reply[j].from.name+"</a>："+reply[j].content+'</div><div class="loadup"><span time="'+replycreateTime+'" class="clearfix replyTime">'+replyshowTime+'</span><span class="clearfix"><button title="回复" data-cid="'+comments[i]._id+'" data-tid="'+reply[j].from._id+'" class="two-rpl-btn"></button></span></div></div></div>';reply_str+=reply_con}var _comment='<dl class="clearfix" data-pripeo="'+comments[i].pripeople+'"><dt><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+comments[i].from._id+'"><img src="'+cpic+'" alt="userImg"></a></dt><dd><div class="all-info"><div class="content-info"><div class="content-title"><a href="javascript:;">'+comments[i].username+'</a><span class="updateNow" time="'+createTime+'">'+showTime+'</span></div><div class="content-txt"><div class="con-txt"><p>'+comments[i].content+'</p></div></div></div><div class="fun reply-btn"><a href="javascript:;" class="com-reply"></a><a href="javascript:;" class="com-prise" data-priid="'+comments[i]._id+'" onclick="prise(this)"></a></div><div class="reply-node" show=0><dl class="first-node"><dt><img src="/images/moren.png"></a></dt><dd><form class="replyForm clearfix" method="POST" action="/user/comment"><input type="hidden" name="comment[movie]" value="'+comments[i].movie+'"/><textarea name="comment[content]" class="comonput"></textarea><div id="con-btn" class="con-btn clearfix"><button class="rpl-reply" type="button">发送</button></div><form/></dd></dl>'+reply_str+"</div></div></dd></dl>";$("#cont-list").append(_comment)}}}},complete:function(){if($("#click_more").text("点击加载更多"),!$("#login_username").text())return!1;var userId=$("#login_username").data("colid"),dls=$("#cont-list dl");dls.each(function(index,item){var $item=$(this),prises=$item.data("pripeo");if(prises)if(prises.indexOf(",")>-1){var prisesarr=prises.split(",");prisesarr.indexOf(userId)>-1?$item.find("dd .reply-btn .com-prise").css({background:"url('/images/heart.png') no-repeat 3px 2px","background-size":"24px 24px"}):$item.find("dd .reply-btn .com-prise").css("background","url('/images/ico.png') no-repeat 0 -860px")}else prises==userId?$item.find("dd .reply-btn .com-prise").css({background:"url('/images/heart.png') no-repeat 3px 2px","background-size":"24px 24px"}):$item.find("dd .reply-btn .com-prise").css("background","url('/images/ico.png') no-repeat 0 -860px");$item.attr("data-pripeo","")})}})})}(),function(){$("#select_all").click(function(){var movieId=$("#mov").data("movid"),userId=$("#login_username").data("colid");$.ajax({type:"POST",url:"/movie/contentAll",data:{movieId:movieId,userId:userId},cache:!1,dataType:"json",beforeSend:function(){$("#cont-list").html(""),$("#click_more").text("加载中...")},success:function(data){var comments=data.comments,datauser=data.user;if(datauser){$("#click_more").attr("data-have",data.have);var upic="";upic=""!=data.user.pic?"/upload/"+data.user.pic:"/images/moren.png";for(var i=0;i<comments.length;i++){var createTime=comments[i].meta.createAt,showTime=(new Date).ago(createTime),cpic="";cpic=""!=comments[i].from.pic?"/upload/"+comments[i].from.pic:"/images/moren.png";var reply=comments[i].reply;if(0==reply.length){var comment='<dl class="clearfix" data-pripeo="'+comments[i].pripeople+'"><dt><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+comments[i].from._id+'"><img src="'+cpic+'" alt="userImg"></a></dt><dd><div class="all-info"><div class="content-info"><div class="content-title"><a href="javascript:;">'+comments[i].username+'</a><span class="updateNow" time="'+createTime+'">'+showTime+'</span></div><div class="content-txt"><div class="con-txt"><p>'+comments[i].content+'</p></div></div></div><div class="fun reply-btn"><a href="javascript:;" class="com-reply"></a><a href="javascript:;" class="com-prise" data-priid="'+comments[i]._id+'" onclick="prise(this)"></a></div><div class="reply-node" show=0><dl class="first-node"><dt><img src="'+upic+'"></a></dt><dd><form class="replyForm clearfix" method="POST" action="/user/comment"><input type="hidden" name="comment[movie]" value="'+comments[i].movie+'"/><input type="hidden" name="comment[from]" value="'+data.user._id+'"/><textarea name="comment[content]" class="comonput"></textarea><div id="con-btn" class="con-btn clearfix"><button class="rpl-reply" type="button">发送</button></div><form/></dd></dl></div></div></dd></dl>';$("#cont-list").append(comment)}else{for(var rpic="",reply_str="",j=0;j<reply.length;j++){var replycreateTime=reply[j].meta.createAt,replyshowTime=(new Date).ago(replycreateTime);rpic=""!=reply[j].from.pic?"/upload/"+reply[j].from.pic:"/images/moren.png";var reply_con='<div class="new-reply-box"><div class="new-box-left"><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+reply[j].from._id+'"><img src="'+rpic+'" alt="用户头像"></a></div><div class="new-box-right"><div class="one-rpl-cont"><a href="javascript:;">'+reply[j].from.name+"</a>："+reply[j].content+'</div><div class="loadup"><span time="'+replycreateTime+'" class="clearfix replyTime">'+replyshowTime+'</span><span class="clearfix"><button title="回复" data-cid="'+comments[i]._id+'" data-tid="'+reply[j].from._id+'" class="two-rpl-btn"></button></span></div></div></div>';
reply_str+=reply_con}var _comment='<dl class="clearfix" data-pripeo="'+comments[i].pripeople+'"><dt><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+comments[i].from._id+'"><img src="'+cpic+'" alt="userImg"></a></dt><dd><div class="all-info"><div class="content-info"><div class="content-title"><a href="javascript:;">'+comments[i].username+'</a><span class="updateNow" time="'+createTime+'">'+showTime+'</span></div><div class="content-txt"><div class="con-txt"><p>'+comments[i].content+'</p></div></div></div><div class="fun reply-btn"><a href="javascript:;" class="com-reply"></a><a href="javascript:;" class="com-prise" data-priid="'+comments[i]._id+'" onclick="prise(this)"></a></div><div class="reply-node" show=0><dl class="first-node"><dt><img src="'+upic+'"></a></dt><dd><form class="replyForm clearfix" method="POST" action="/user/comment"><input type="hidden" name="comment[movie]" value="'+comments[i].movie+'"/><input type="hidden" name="comment[from]" value="'+data.user._id+'"/><textarea name="comment[content]" class="comonput"></textarea><div id="con-btn" class="con-btn clearfix"><button class="rpl-reply" type="button">发送</button></div><form/></dd></dl>'+reply_str+"</div></div></dd></dl>";$("#cont-list").append(_comment)}}}else{$("#click_more").attr("data-have",data.have);for(var i=0;i<comments.length;i++){var createTime=comments[i].meta.createAt,showTime=(new Date).ago(createTime),cpic="";cpic=""!=comments[i].from.pic?"/upload/"+comments[i].from.pic:"/images/moren.png";var reply=comments[i].reply;if(0==reply.length){var comment='<dl class="clearfix" data-pripeo="'+comments[i].pripeople+'"><dt><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+comments[i].from._id+'"><img src="'+cpic+'" alt="userImg"></a></dt><dd><div class="all-info"><div class="content-info"><div class="content-title"><a href="javascript:;">'+comments[i].username+'</a><span class="updateNow" time="'+createTime+'">'+showTime+'</span></div><div class="content-txt"><div class="con-txt"><p>'+comments[i].content+'</p></div></div></div><div class="fun reply-btn"><a href="javascript:;" class="com-reply"></a><a href="javascript:;" class="com-prise" data-priid="'+comments[i]._id+'" onclick="prise(this)"></a></div><div class="reply-node" show=0><dl class="first-node"><dt><img src="/images/moren.png"></a></dt><dd><form class="replyForm clearfix" method="POST" action="/user/comment"><input type="hidden" name="comment[movie]" value="'+comments[i].movie+'"/><textarea name="comment[content]" class="comonput"></textarea><div id="con-btn" class="con-btn clearfix"><button class="rpl-reply" type="button">发送</button></div><form/></dd></dl></div></div></dd></dl>';$("#cont-list").append(comment)}else{for(var rpic="",reply_str="",j=0;j<reply.length;j++){var replycreateTime=reply[j].meta.createAt,replyshowTime=(new Date).ago(replycreateTime);rpic=""!=reply[j].from.pic?"/upload/"+reply[j].from.pic:"/images/moren.png";var reply_con='<div class="new-reply-box"><div class="new-box-left"><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+reply[j].from._id+'"><img src="'+rpic+'" alt="用户头像"></a></div><div class="new-box-right"><div class="one-rpl-cont"><a href="javascript:;">'+reply[j].from.name+"</a>："+reply[j].content+'</div><div class="loadup"><span time="'+replycreateTime+'" class="clearfix replyTime">'+replyshowTime+'</span><span class="clearfix"><button title="回复" data-cid="'+comments[i]._id+'" data-tid="'+reply[j].from._id+'" class="two-rpl-btn"></button></span></div></div></div>';reply_str+=reply_con}var _comment='<dl class="clearfix" data-pripeo="'+comments[i].pripeople+'"><dt><a href="javascript:;" data-cid="'+comments[i]._id+'" data-tid="'+comments[i].from._id+'"><img src="'+cpic+'" alt="userImg"></a></dt><dd><div class="all-info"><div class="content-info"><div class="content-title"><a href="javascript:;">'+comments[i].username+'</a><span class="updateNow" time="'+createTime+'">'+showTime+'</span></div><div class="content-txt"><div class="con-txt"><p>'+comments[i].content+'</p></div></div></div><div class="fun reply-btn"><a href="javascript:;" class="com-reply"></a><a href="javascript:;" class="com-prise" data-priid="'+comments[i]._id+'" onclick="prise(this)"></a></div><div class="reply-node" show=0><dl class="first-node"><dt><img src="/images/moren.png"></a></dt><dd><form class="replyForm clearfix" method="POST" action="/user/comment"><input type="hidden" name="comment[movie]" value="'+comments[i].movie+'"/><textarea name="comment[content]" class="comonput"></textarea><div id="con-btn" class="con-btn clearfix"><button class="rpl-reply" type="button">发送</button></div><form/></dd></dl>'+reply_str+"</div></div></dd></dl>";$("#cont-list").append(_comment)}}}},complete:function(){if($("#click_more").text("点击加载更多"),!$("#login_username").text())return!1;var userId=$("#login_username").data("colid"),dls=$("#cont-list dl");dls.each(function(index,item){var $item=$(this),prises=$item.data("pripeo");if(prises)if(prises.indexOf(",")>-1){var prisesarr=prises.split(",");prisesarr.indexOf(userId)>-1?$item.find("dd .reply-btn .com-prise").css({background:"url('/images/heart.png') no-repeat 3px 2px","background-size":"24px 24px"}):$item.find("dd .reply-btn .com-prise").css("background","url('/images/ico.png') no-repeat 0 -860px")}else prises==userId?$item.find("dd .reply-btn .com-prise").css({background:"url('/images/heart.png') no-repeat 3px 2px","background-size":"24px 24px"}):$item.find("dd .reply-btn .com-prise").css("background","url('/images/ico.png') no-repeat 0 -860px");$item.attr("data-pripeo","")})}})})}()}main()});